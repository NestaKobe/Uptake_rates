---
title: "Weekly feeback"
author: "Simon Coburg; IMBRSea 20191199 - CCMAR a73216"
date: "07/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Thesis "Seagrass domination over seaweeds in oligotrophic coastal ecosystems"

<font size="3"> with supervisors: *[Ana Alexandre](https://www.ccmar.ualg.pt/users/aalexandre), [Carmen de los Santos](https://www.ccmar.ualg.pt/users/cbsantos) & [Rui Santos](https://www.ccmar.ualg.pt/users/rosantos), CCMAR* </font>

---

*R script - [GitHub](https://github.com/NestaKobe/Uptake_rates)*

---

PRISMA protocol step **Eligibility**

*of full-text articles assessed for eligibility:* 344

- total studies assessed at present: 128

- of full-text articles excluded with reasons: 21

- of full-text articles on waiting list: 42

- <u> of studies included in qualitative synthesis: 65 </u>

<br>

### Exploratory data analysis
<br>
```{r loading libraries, include=FALSE}

# load libraries
packages <- c("tidyverse",      # for data science (general) - includes ggplot2
              "readxl",         # for reading xlsx files
              "devtools",
              "ggpubr")

for (i in seq_along(packages)) {
  if(!do.call(require, list(package = packages[i]))) {
    do.call(install.packages, list(pkgs = packages[i]))
    do.call(require, list(package = packages[i]))
  }
}

# set working directory
setwd("~/Documents/IMBRSea/Thesis S4/Rstudio Uptake rates")
```

```{r loading data, include=FALSE}

# load SOURCES
data.sou  <- read_excel("~/Documents/IMBRSea/Thesis S4/Database uptake rate_07.05.2021.xlsx",
                        sheet="sources",na="NA",skip=3)

str(data.sou)
names(data.sou)

# load ENVIRONMENTAL
data.env  <- read_excel("~/Documents/IMBRSea/Thesis S4/Database uptake rate_07.05.2021.xlsx",
                        sheet="environmental",na="NA",skip=3)
str(data.env)
names(data.env)

# load EXPERIMENTAL
data.exp  <- read_excel("~/Documents/IMBRSea/Thesis S4/Database uptake rate_07.05.2021.xlsx",
                        sheet="experimental",na="NA",skip=3)
str(data.exp)
names(data.exp)
```

```{r converting numeric, warning=FALSE, include=FALSE}

data.exp$Vmax   <- as.numeric(data.exp$Vmax)
data.exp$Km     <- as.numeric(data.exp$Km)
data.exp$alpha  <- as.numeric(data.exp$alpha)
data.exp$sampling_inter <- as.numeric(data.exp$sampling_inter)

```

**Quality controls for ENVIRONMENTAL/EXPERIMENTAL**
<br>
Comparison between spreadsheets *environmental* and *experimental* whether <u> UNIQUE IDs </u>
coincide.
```{r}
length(unique(data.env$id_short))
length(unique(data.exp$id_short))
```
<br>

### Dataset
<br>

**Publication year**
<br>
Peer-reviewed publications assessed by year up to date
<br>

```{r publication year, echo=FALSE, warning=FALSE}
ggplot(data.sou, aes(x=year)) +
      geom_bar(stat="count") +
      ggtitle("Publication year") + 
      labs(x="Year of publication", y="Number of articles") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5)) +
      scale_x_continuous(limits=c(1980, 2021), breaks=seq(1980,2021,5))
```

**Sampling locations**
<br>
Amount of peer-reveiwed articles' sampling countries up to date
<br>

```{r sampling location, echo=FALSE, warning=FALSE}
genv <- unique(data.env[,c("id_short", "sample_country")]) # create data for ggplot - 

#using the unique function with study_id and sample_country you eliminate repeated countries within the same study
gdata <- data.frame(table(genv$sample_country)) # this is to create a frequency table for countries
names(gdata) <- c("sample_country","n")

ggplot(gdata, aes(x=reorder(sample_country,n), y=n)) +   # here I have added "reorder" so in the plot you can see countries ordered by frequency
      geom_bar(stat="identity", na.rm=FALSE) + 
      coord_flip() +
      scale_x_discrete("Country") +
      scale_y_continuous("Number of studies") +
      theme_bw() 

rm(gdata) # delete gdata
```

<br>

**Species type**
<br>
Registered values portrayed by species types *Algae* and *Seagrasses*, by *phyla* and the species *compartments*

```{r species type, echo=FALSE}
ggplot(data.exp, aes(x=species_type)) +
        geom_bar(stat="count",  width = .5) +
        geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white") +
        ggtitle("Registered values by species type") + 
        labs(x="Species type", y="Number of registered values") +
        theme_bw()+
        theme(plot.title = element_text(hjust = 0.5))

ggplot(data.exp, aes(x=species_type, fill=species_phyla)) +
        scale_fill_manual(values = c("forestgreen", "salmon4", "red2", "springgreen4")) +
        geom_bar(stat="count", position=position_dodge(),  width = .6)+
        ggtitle("Species phyla") + 
        labs(x="Species type", y="Number of registered values") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5), legend.position="right") +
        theme(legend.title = element_blank()) +
        theme(legend.position = c(.85,.8))

ggplot(data.exp, aes(x=species_type, colour=species_compartm, fill=species_compartm)) +
        geom_bar(stat="count", position=position_dodge(), width= .6) +
        ggtitle("Species compartment") + 
        labs(x="Species type", y="Number of registered values") +
        theme_bw() +
        theme(plot.title = element_text(hjust = 0.5), legend.position="right") +
        theme(legend.title = element_blank()) +
        theme(legend.position = c(.85,.8))

```
<br>

**Composition of registered uptake rate values**
<br>
Number of registered values by the type of incubation *Single* or *Range*.
<br>
*Note: Majority are single Vmax values extracted from articles which are missing values for* Km *and* alpha

```{r incubation type, echo=FALSE, warning=FALSE}
#Incubation type / surge or int. contr. phase
ggplot(data.exp, aes(x=type_uptake, fill=type_uptake))+
      geom_bar(stat="count") +
      facet_grid(type_incub~species_type) +
      scale_size_manual(values=c(5))+
      ggtitle("Surge uptake vs. Internally controlled phase") + 
      labs(x="Uptake type", y="Number of registered values") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5)) +
      theme(legend.position = "none")
```
<br>
<br>

#### Alpha values
Alpha frequency distribution of values registered up to date

```{r alpha distribution, echo=FALSE, warning=FALSE}
ggplot(data.exp, aes(x=alpha, group=species_type, fill=species_type))+
      geom_density(alpha=0.4) +
      ggtitle("Alpha values (Range)") + 
      labs(x="Alpha [l g^-1 dw h^-1 µM^-1]", y="Frequency") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5)) +
      theme(legend.title = element_blank()) +
      theme(legend.position = c(.9,.9))

ggplot(data.exp, aes(x=alpha))+
      geom_histogram(binwidth=0.1, 
                     breaks = seq(0, 15, by = 0.2), 
                     colour = "black", 
                     fill = "white") +
      geom_rug() +
      geom_density(aes(y=..density..*10), colour="blue") +
      scale_x_continuous(limits=c(0, 15)) +
      scale_y_continuous(limits=c(0, 15)) +
      facet_grid(.~species_type) +
      ggtitle("") + 
      labs(x="Alpha", y="Frequency") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5))

```

<br>

Values for alpha portrayed by *nutrients*, *nutrients* & *species compartment* and *nutrients* & *uptake types*
<br>

```{r alpha, echo=FALSE, warning=FALSE}
ggplot(data.exp, aes(x=alpha, y=temperature_experiment, colour=species_type)) +
      geom_point() +
      facet_grid(.~nutrient) +
      ggtitle("Alpha values for nutrients") + 
      labs(x="Alpha", y="Temperature [ºC]") +
      scale_y_continuous(limits=c(0, 30), breaks=seq(0,30,5)) +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5)) +
      theme(legend.title = element_blank()) +
      theme(legend.position = "bottom")


ggplot(data.exp, aes(x=alpha, y=temperature_experiment, colour=species_type)) +
      geom_point() +
      facet_grid(species_compartm~nutrient) +
      ggtitle("Alpha values by nutrient & species compartment") + 
      labs(x="Alpha", y="Temperature [ºC]") +
      scale_y_continuous(limits=c(0, 30), breaks=seq(0,30,5)) +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5)) +
      theme(legend.title = element_blank()) +
      theme(legend.position = "bottom")


ggplot(data.exp, aes(x=alpha, y=temperature_experiment, colour=species_type)) +
      geom_point() +
      facet_grid(type_uptake~nutrient) +
      ggtitle("Alpha values by nutrient & uptake type") + 
      labs(x="Alpha", y="Temperature [ºC]") +
      scale_y_continuous(limits=c(0, 30), breaks=seq(0,30,5)) +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5)) +
      theme(legend.title = element_blank()) +
      theme(legend.position = "bottom")
```

#### Vmax values
<br>
Vmax frequency distribution for registered *Range* and *Single* values up to date
<br>

```{r Vmax distribution, echo=FALSE, warning=FALSE}
v1 <- ggplot(data.exp, aes(x=Vmax, group=species_type, fill=species_type))+
            geom_density(alpha=0.4) +
            ggtitle("Vmax values (Range)") + 
            labs(x="", y="") +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(legend.title = element_blank()) +
            theme(legend.position = "bottom")

      #Log transformation
      v2 <- ggplot(data.exp, aes(x=Vmax, group=species_type, fill=species_type))+
                  geom_density(alpha=0.5) +
                  scale_x_log10() +
                  ggtitle("") + 
                  labs(x="log10", y="") +
                  theme_bw() +
                  theme(plot.title = element_text(hjust = 0.5)) +
                  theme(legend.position = "none")
      
#Vmax Single
v3 <- ggplot(data.exp, aes(x=uptake_rate_dw, group=species_type, fill=species_type))+
            geom_density(alpha=0.5) +
            ggtitle("Vmax values (Single)") +
            labs(x="", y="") +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(legend.title = element_blank()) +
            theme(legend.position = "bottom")

      #Log transformed
      v4 <- ggplot(data.exp, aes(x=uptake_rate_dw, group=species_type, fill=species_type))+
                  geom_density(alpha=0.5) +
                  scale_x_log10() +
                  ggtitle("") +
                  labs(x="log10", y="") +
                  theme_bw() +
                  theme(plot.title = element_text(hjust = 0.5)) +
                  theme(legend.title = element_blank()) +
                  theme(legend.position = "none")
      
plot1 <- ggarrange(v1, v3, ncol = 2, nrow = 1)

plot2 <- ggarrange(v2, v4, ncol = 2, nrow = 1)

annotate_figure(plot1, 
                top = text_grob("Vmax distribution", face="bold"),
                left = text_grob("Frequency"))

annotate_figure(plot2,
                left = text_grob("Frequency"),
                bottom = text_grob("Vmax"))


#Vmax Range
ggplot(data.exp, aes(x=Vmax))+
      geom_histogram(binwidth=10, 
                     breaks = seq(0, 500, by = 10), 
                     colour = "black", 
                     fill = "white") +
      geom_rug() +
      geom_density(aes(y=..density..*750), colour="blue") +
      scale_x_continuous(limits=c(0, 500)) +
      scale_y_continuous(limits=c(0, 30)) +
      facet_grid(.~species_type) +
      ggtitle("Vmax values (Range)") + 
      labs(x="Vmax", y="Frequency") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5))

#Vmax Single
ggplot(data.exp, aes(x=uptake_rate_dw))+
      geom_histogram(binwidth=10, 
                     breaks = seq(-100, 450, by = 15), 
                     colour = "black", 
                     fill = "white") +
      geom_rug() +
      geom_density(aes(y=..density..*1000), colour="blue") +
      scale_x_continuous(limits=c(-100, 500)) +
      scale_y_continuous(limits=c(0, 400)) +
      facet_grid(.~species_type) +
      ggtitle("Vmax values (Single)") + 
      labs(x="Vmax", y="Frequency") +
      theme_bw() +
      theme(plot.title = element_text(hjust = 0.5))

```
<br>

Values of Vmax portrayed for registered *Range* and *Single* values by *nutrients*
<br>

```{r nutrient, echo=FALSE, warning=FALSE}
#RANGE Boxplot + jitter for nutrients
r1 <- ggplot(data.exp, aes(x=species_type, y=Vmax)) +
            geom_boxplot(outlier.shape=NA) +
            geom_jitter(width=0.3, shape=21) +
            facet_grid(.~nutrient) +
            ggtitle("Range") + 
            labs(x="", y="") +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle = 90))

#Boxplot + jitter for nutrients coloured
r2 <- ggplot(data.exp, aes(x=species_type, y=Vmax)) +
            geom_boxplot(aes(colour = factor(type_uptake)),outlier.shape = NA) +
            geom_jitter(aes(colour = factor(type_uptake)), width=0.3, shape=21) +
            facet_grid(.~nutrient) +
            ggtitle("") + 
            labs(x="", y="") +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle = 90)) +
            theme(legend.title = element_blank()) +
            theme(legend.position = "top")


#SINGLE Boxplot + jitter for nutrients
s1 <- ggplot(data.exp, aes(x=species_type, y=uptake_rate_dw)) +
            geom_boxplot(outlier.shape=NA) +
            geom_jitter(width=0.3, shape=21) +
            facet_grid(.~nutrient) +
            ggtitle("Single") +
            labs(x="", y="") +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle = 90))

#SI|NGLE Boxplot + jitter for nutrients coloured
s2 <- ggplot(data.exp, aes(x=species_type, y=uptake_rate_dw)) +
            geom_boxplot(aes(colour = factor(type_uptake)),outlier.shape = NA) +
            geom_jitter(aes(colour = factor(type_uptake)), width=0.3, shape=21) +
            facet_grid(.~nutrient) +
            ggtitle("") + 
            labs(x="", y="") +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)) +
            theme(axis.text.x = element_text(angle = 90)) +
            theme(legend.title = element_blank()) +
            theme(legend.position = "top")


plot3 <- ggarrange(r1, s1, ncol = 2, nrow = 1)

plot4 <- ggarrange(r2, s2, ncol = 2, nrow = 1)

annotate_figure(plot3, 
                top = text_grob("Vmax values for nutrients", face="bold"),
                left = text_grob("Vmax"))

annotate_figure(plot4,
                bottom = text_grob("Species type"),
                left = text_grob("Vmax"))
```
<br>
